#Parte 2 - Ansible-Client

- hosts: all
  become: yes
  vars:
    suporte_public_key_path: /home/suporte/.ssh/id_rsa.pub
  tasks:
    - name: Alterando o nome do Linux
      hostname:
        name: client

    - name: Instalando os Pacotes
      apt:
        update_cache: yes
        name:
          - acl
          - python3-pip
          - python3-pexpect
          - expect
        state: present

   # Network Requirement
    - name: Copy network interfaces file
      copy:
        src: ../network/client/interfaces
        dest: /etc/network/interfaces
      

    - name: Restart networking.service
      command: "sudo systemctl restart networking.service"

      # Create users
    - name: Create users
      become: true
      user:
        name: "{{ item }}"
        shell: /bin/bash
        createhome: yes
        home: "/home/{{ item }}"
        state: present
        password: "{{ '1234' | password_hash('sha512') }}"
      with_items:
        - suporte
        - jornalista

    - name: Generate SSH key pair for suporte
      command: ssh-keygen -t rsa -b 4096 -C "suporte@abranteme.com.br" -f /home/suporte/.ssh/id_rsa -P ""
      become: true
      become_user: suporte

#parâmetro autenticatorpassword yes já vem la do servidor para permitir encaminhar a chave===

    - name: Copy SSH key to remote server
      expect:
        command: ssh-copy-id -o StrictHostKeyChecking=no suporte@10.0.128.1
        responses:
          "password": "1234"
      become: true
      become_user: suporte

    - name: Copy temporary sshd_config file to Client
      become: true
      become_user: suporte
      copy:
        src: ../sec_access/veridis/sshd_config
        dest: /tmp/sshd_config

    - name: Copy sshd_config file to remote server
      expect:
        command: scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /tmp/sshd_config root@10.0.128.1:/etc/ssh/sshd_config
        responses:
          "password": "vagrant"
      become: true
      become_user: suporte

    - name: Restart SSH service on remote server as root
      expect:
        command: ssh -o StrictHostKeyChecking=no root@10.0.128.1 systemctl restart ssh
        responses:
          "password": "vagrant"

    - name: Remove temporary sshd file config
      file:
        path: /tmp/sshd_config
        state: absent



 

   


    
